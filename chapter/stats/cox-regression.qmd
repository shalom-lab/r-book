**Cox å›å½’**ï¼ˆCox Proportional Hazards Modelï¼‰æ˜¯ä¸€ç§å¹¿æ³›åº”ç”¨äºç”Ÿå­˜åˆ†æçš„å›å½’æ¨¡å‹ï¼Œç‰¹åˆ«é€‚ç”¨äºæ¢ç´¢å¤šä¸ªå˜é‡ä¸äº‹ä»¶å‘ç”Ÿæ—¶é—´ä¹‹é—´çš„å…³ç³»ã€‚å…¶ä¸»è¦åº”ç”¨æ˜¯åˆ†æç”Ÿå­˜æ•°æ®ã€ç–¾ç—…å‘ç”Ÿæ—¶é—´æˆ–å…¶ä»–äº‹ä»¶æ—¶é—´ï¼ˆä¾‹å¦‚æ­»äº¡ã€å¤å‘ç­‰ï¼‰ä¸å¤šä¸ªå½±å“å› ç´ ä¹‹é—´çš„å…³è”ã€‚

## Cox å›å½’çš„åŸç†

Cox å›å½’æ¨¡å‹æ˜¯åŸºäº**æ¯”ä¾‹é£é™©å‡è®¾**ï¼ˆProportional Hazards Assumptionï¼‰çš„ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä¸åŒç»„ä¹‹é—´çš„é£é™©æ¯”ï¼ˆHazard Ratioï¼ŒHRï¼‰æ˜¯æ’å®šçš„ï¼Œä½†æ¯ä¸ªä¸ªä½“çš„é£é™©éšæ—¶é—´å˜åŒ–çš„é€Ÿç‡å¯èƒ½ä¸åŒã€‚è¯¥æ¨¡å‹çš„ç›®çš„æ˜¯ä¼°è®¡ä¸€ä¸ªæˆ–å¤šä¸ªåå˜é‡å¯¹ç”Ÿå­˜æ—¶é—´çš„å½±å“ï¼Œå‡å®šåå˜é‡å¯¹é£é™©çš„å½±å“æ˜¯æ’å®šçš„ï¼Œä¸éšæ—¶é—´å˜åŒ–ã€‚

Cox æ¨¡å‹çš„åŸºæœ¬å½¢å¼ä¸ºï¼š $$h(t | X) = h_0(t) \exp(\beta_1 X_1 + \beta_2 X_2 + \dots + \beta_p X_p)$$ å…¶ä¸­ï¼š - $h(t|X)$ æ˜¯ç»™å®šåå˜é‡ ğ‘‹ çš„æ¡ä»¶é£é™©å‡½æ•°ï¼Œ - $h_0(t)$ æ˜¯åŸºå‡†é£é™©å‡½æ•°ï¼Œ - $\beta_1, \beta_2, ..., \beta_p$ æ˜¯åå˜é‡ç³»æ•°ã€‚

## é£é™©å‡½æ•°ï¼ˆHazard Functionï¼‰

é£é™©å‡½æ•° h(t)h(t)h(t) æ˜¯æŒ‡åœ¨æŸä¸€æ—¶åˆ» tttï¼Œä¸ªä½“è¿˜å­˜æ´»çš„æ¡ä»¶ä¸‹å‘ç”Ÿäº‹ä»¶çš„å³æ—¶é€Ÿç‡ã€‚å¯¹äº Cox æ¨¡å‹ï¼Œé£é™©å‡½æ•°ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼š

1.  **åŸºå‡†é£é™©å‡½æ•°** $h_0(t)$ï¼šè¡¨ç¤ºæ²¡æœ‰ä»»ä½•åå˜é‡å½±å“æ—¶çš„é£é™©ã€‚å®ƒæ˜¯æ—¶é—´çš„å‡½æ•°ï¼Œä½†ä¸åå˜é‡æ— å…³ã€‚
2.  **åå˜é‡çš„æŒ‡æ•°éƒ¨åˆ†**ï¼šè¡¨ç¤ºåå˜é‡å¯¹é£é™©çš„å½±å“ã€‚å®ƒé€šè¿‡åå˜é‡çš„çº¿æ€§ç»„åˆåŠ æƒï¼Œé€šå¸¸è¢«è¡¨ç¤ºä¸º $\exp(\beta_1 X_1 + \beta_2 X_2 + \dots + \beta_p X_p$

Cox æ¨¡å‹çš„æ¯”ä¾‹é£é™©å‡è®¾è®¤ä¸ºï¼Œæ‰€æœ‰ä¸ªä½“çš„é£é™©æ¯”ï¼ˆHazard Ratioï¼ŒHRï¼‰æ˜¯æ’å®šçš„ï¼Œå³ï¼šåå˜é‡çš„æ•ˆåº”æ˜¯æ¯”ä¾‹æ€§çš„ï¼Œå¹¶ä¸”å¯¹æ‰€æœ‰ä¸ªä½“åœ¨ä¸åŒæ—¶é—´ç‚¹ä¸Šå½±å“ç›¸åŒã€‚

## é£é™©æ¯”ï¼ˆHazard Ratioï¼ŒHRï¼‰

åœ¨ Cox å›å½’æ¨¡å‹ä¸­ï¼Œ**é£é™©æ¯”**ï¼ˆHRï¼‰æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œè¡¨ç¤ºä¸€ä¸ªå•ä½çš„åå˜é‡å˜åŒ–å¯¹é£é™©å‡½æ•°çš„ç›¸å¯¹å½±å“ã€‚å…¶å®šä¹‰ä¸ºï¼š

$HR= exp(\beta)$

å…¶ä¸­ $\beta$ æ˜¯å›å½’ç³»æ•°ã€‚é£é™©æ¯”çš„è§£é‡Šï¼š

-   **HR = 1**ï¼šåå˜é‡å¯¹é£é™©æ²¡æœ‰å½±å“ã€‚
-   **HR \> 1**ï¼šåå˜é‡çš„å¢åŠ ä¼šå¢åŠ äº‹ä»¶å‘ç”Ÿçš„é£é™©ã€‚
-   **HR \< 1**ï¼šåå˜é‡çš„å¢åŠ ä¼šé™ä½äº‹ä»¶å‘ç”Ÿçš„é£é™©ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾æŸä¸ªå›å½’ç³»æ•° $Î²$=0.5ï¼Œé‚£ä¹ˆé£é™©æ¯” $HR=exp(0.5)=1.65$ã€‚è¿™æ„å‘³ç€åå˜é‡å¢åŠ ä¸€ä¸ªå•ä½æ—¶ï¼Œäº‹ä»¶å‘ç”Ÿçš„é£é™©ä¼šå¢åŠ  65%ã€‚

## åŸºå‡†é£é™©å‡½æ•°ï¼ˆBaseline Hazard Functionï¼‰

åŸºå‡†é£é™©å‡½æ•°$h_0(t)$æ˜¯ Cox æ¨¡å‹çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ã€‚å®ƒè¡¨ç¤ºå½“æ‰€æœ‰åå˜é‡ $X=0$ï¼ˆå³æ²¡æœ‰ä»»ä½•åå˜é‡å½±å“ï¼‰æ—¶çš„é£é™©ã€‚åŸºå‡†é£é™©å‡½æ•°é€šå¸¸æ˜¯æ— æ³•é€šè¿‡æ•°æ®ç›´æ¥ä¼°è®¡çš„ï¼Œå› ä¸ºå®ƒå—åˆ°æ—¶é—´çš„å½±å“ï¼Œå¹¶ä¸”åœ¨ Cox æ¨¡å‹ä¸­è¢«å¤„ç†ä¸ºä¸€ä¸ªæ— å…³å‚æ•°ï¼Œæœ€ç»ˆçš„æ¨¡å‹ä¸ä¼šç›´æ¥ç»™å‡ºåŸºå‡†é£é™©å‡½æ•°çš„å…·ä½“å½¢å¼ã€‚

é€šå¸¸ï¼ŒCox æ¨¡å‹çš„ç›®æ ‡æ˜¯ä¼°è®¡åå˜é‡å¯¹é£é™©çš„ç›¸å¯¹å½±å“ï¼Œè€Œä¸æ˜¯ä¼°è®¡åŸºå‡†é£é™©æœ¬èº«ã€‚åŸºå‡†é£é™©å‡½æ•°åœ¨ä¼°è®¡åå˜é‡æ•ˆåº”æ—¶æ˜¯è¢«æ¶ˆé™¤çš„ï¼Œå› æ­¤ Cox æ¨¡å‹æ˜¯**åŠå‚æ•°æ¨¡å‹**ã€‚

## Cox å›å½’æ¨¡å‹çš„ä¼°è®¡ä¸å‡è®¾

Cox å›å½’æ¨¡å‹çš„ä¼°è®¡æ˜¯é€šè¿‡æœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼ˆMLEï¼‰è¿›è¡Œçš„ã€‚ç”±äº Cox æ¨¡å‹ä¸éœ€è¦æ˜ç¡®æŒ‡å®šåŸºå‡†é£é™©å‡½æ•°ï¼Œå®ƒå±äºåŠå‚æ•°æ¨¡å‹ã€‚æ¨¡å‹çš„ä¼°è®¡åŸºäºéƒ¨åˆ†ä¼¼ç„¶å‡½æ•°ï¼ˆpartial likelihoodï¼‰ï¼Œå®ƒä¸»è¦ä¾èµ–äºæ•°æ®ä¸­æ—¶é—´é¡ºåºå’Œäº‹ä»¶å‘ç”Ÿçš„æƒ…å†µã€‚

**æ¯”ä¾‹é£é™©å‡è®¾**æ˜¯ Cox æ¨¡å‹çš„å…³é”®å‡è®¾ä¹‹ä¸€ï¼Œå‡è®¾ä¸åŒç»„ä¹‹é—´çš„é£é™©æ¯”æ˜¯æ’å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸åŒä¸ªä½“çš„é£é™©å‡½æ•°çš„æ¯”ä¾‹å…³ç³»éšæ—¶é—´ä¸å˜ã€‚

## æ¨¡å‹è¯Šæ–­

-   **æ¯”ä¾‹é£é™©å‡è®¾æ£€éªŒ**ï¼šé€šè¿‡ Schoenfeld æ®‹å·®æˆ–æ—¶é—´äº¤äº’é¡¹æ¥æ£€éªŒæ¯”ä¾‹é£é™©å‡è®¾æ˜¯å¦æˆç«‹ã€‚å¦‚æœæ¯”ä¾‹é£é™©å‡è®¾ä¸æˆç«‹ï¼Œå¯èƒ½éœ€è¦å¯¹æ¨¡å‹è¿›è¡Œä¿®æ­£ï¼Œä¾‹å¦‚ä½¿ç”¨æ—¶é—´äº¤äº’é¡¹æˆ–é€‰æ‹©å…¶ä»–æ–¹æ³•ã€‚
-   **æ®‹å·®åˆ†æ**ï¼šå¯ä»¥é€šè¿‡æ®‹å·®åˆ†æï¼ˆå¦‚ Cox-Snell æ®‹å·®ï¼‰æ¥è¯„ä¼°æ¨¡å‹æ‹Ÿåˆçš„å¥½åã€‚

## é£é™©å‡½æ•°ä¸ç”Ÿå­˜å‡½æ•°çš„å…³ç³»

ç”Ÿå­˜å‡½æ•°è¡¨ç¤ºä¸ªä½“æ´»è¿‡tæ—¶é—´çš„æ¦‚ç‡ï¼š $$S(t) = P(T > t)$$

ç”Ÿå­˜å‡½æ•°ä¸é£é™©å‡½æ•°çš„å…³ç³»ä¸ºï¼š

$$S(t) = \exp\left( - \int_0^t h(u) \, du \right)$$ $$h(t) = -\frac{d}{dt} \log(S(t))$$ Coxå›å½’ç”Ÿå­˜æ¦‚ç‡çš„è®¡ç®—

$$S(t | X) = \exp\left( - \int_0^t h(t|X) \, du \right)$$

$$S(t | X) = \exp\left( - \exp(\beta_1 X_1 + \dots + \beta_p X_p) \int_0^t h_0(u) \, du \right)$$ $$S_0(t) = \exp\left( - \int_0^t h_0(u) \, du \right)$$

$$S(t | X) = S_0(t)^{\exp(\beta_1 X_1 + \dots + \beta_p X_p)}$$

å› æ­¤åˆ©ç”¨Coxå›å½’é¢„æµ‹ä¸ªä½“çš„ç”Ÿå­˜æ¦‚ç‡ï¼Œéœ€è¦å…ˆè®¡ç®—$S_0(t)$,è¿˜æœ‰çº¿æ€§é¡¹$\exp(\beta_1 X_1 + \beta_2 X_2 + \dots + \beta_p X_p$

## ç´¯è®¡é£é™©å‡½æ•°

ç´¯è®¡é£é™©å‡½æ•°çš„å®šä¹‰ï¼š

$$
H(t)=\int_0^th(u)du
$$

**Nelson-Aalenä¼°è®¡é‡** æ˜¯ä¸€ç§éå‚æ•°æ–¹æ³•ï¼Œç”¨äºä¼°è®¡ç´¯ç§¯é£é™©å‡½æ•°ï¼ˆCumulative Hazard Function, $H(t)$ï¼Œä¸»è¦åº”ç”¨äºç”Ÿå­˜åˆ†æä¸­ã€‚å®ƒæ˜¯ä¸€ç§åŸºäºäº‹ä»¶å‘ç”Ÿæ—¶é—´çš„**é€æ­¥ç´¯ç§¯**çš„ä¼°è®¡æ–¹æ³•ã€‚

$$
\hat{H}(t) = \sum_{t_i \leq t} \frac{d_i}{Y_i}
$$

```{r}
library(tidyverse)
library(survival)

head(lung)
```

```{r}
lung %>%
  drop_na() %>%
  summarise(death=sum(status==2),death_censor=n(),.by=time) %>%
  arrange(time) %>%
  mutate(total=sum(death_censor),
         at_risk=total-cumsum(lag(death,default=0)),
         nelson_h=cumsum(death/at_risk))

fit_cox <- coxph(Surv(time, status) ~ 1 , data=na.omit(lung), method = "breslow")
basehaz(fit_cox)
```

```{r}
bind_cols(
  basehaz(coxph(Surv(time, status) ~ 1 , data=na.omit(lung), method = "breslow")),
  basehaz(coxph(Surv(time, status) ~ 1 , data=na.omit(lung)))[1],
  basehaz(coxph(Surv(time, status) ~ sex , data=na.omit(lung),method = "breslow"))[1]
)
```

```{r}
df<-na.omit(lung)
fit_cox <- coxph(Surv(time, status) ~ age +sex, data=df, x=T,method = "breslow")
summary(fit_cox)
coef(fit_cox)

breslow_est <- function(time, status, X, B){
  data <- data.frame(time, status, X)
  data <- data[order(data$time), ]
  t <-  unique(data$time)
  k <- length(t)
  h <- rep(0,k)
  
  for(i in 1:k) {
    lp <- (data.matrix(data[,-c(1:2)]) %*% B)[data$time>=t[i]]
    risk <- exp(lp)
    h[i] <- sum(filter(data,status==2,time==t[i]) %>% 
                  nrow()) / sum(risk)
  }
  
  res <- cumsum(h)
  return(res)
}
bind_cols(
  basehaz(fit_cox,centered = F),
  breslow_h=breslow_est(df$time,df$status,fit_cox$x,coef(fit_cox))
)

```

```{r}
df<-na.omit(lung)
fit_cox <- coxph(Surv(time, status) ~ age +sex, data=df, x=T,method = "breslow")
summary(fit_cox)
coef(fit_cox)

breslow_est <- function(time, status, X, B){
  data <- data.frame(time, status, X)
  data <- data[order(data$time), ]
  t <-  unique(data$time)
  k <- length(t)
  h <- rep(0,k)
  
  for(i in 1:k) {
    lp_sample <- sum(fit_cox$means * coef(fit_cox))
    lp_individual <-(data.matrix(data[,-c(1:2)]) %*% B)
    lp_centered=lp_individual-lp_sample
    lp <- lp_centered[data$time>=t[i]]
    risk <- exp(lp)
    h[i] <- sum(filter(data,status==2,time==t[i]) %>% 
                  nrow()) / sum(risk)
  }
  
  res <- cumsum(h)
  return(res)
}
bind_cols(
  basehaz(fit_cox,centered = T),
  breslow_h=breslow_est(df$time,df$status,fit_cox$x,coef(fit_cox))
)
```

```{r}
fit_cox <- 
  coxph(Surv(time, status) ~ age + sex, x=TRUE, data=df, method = "breslow")

X_centered <- sweep(fit_cox$x, 2, fit_cox$means, "-")
bind_cols(
  basehaz(fit_cox,centered = F),
  breslow_h=breslow_est(df$time,df$status,fit_cox$x,coef(fit_cox))
)
```
